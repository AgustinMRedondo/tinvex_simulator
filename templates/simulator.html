<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tinvex AMM Simulator - Auto Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto p-8 max-w-7xl">
        <h1 class="text-5xl font-bold mb-2 text-center bg-gradient-to-r from-blue-400 to-purple-500 text-transparent bg-clip-text">
            Tinvex AMM Simulator
        </h1>
        <p class="text-center text-gray-400 mb-8">Continuous Auto-Trading with Rugpull Detection</p>
        
        <!-- Setup Panel -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-blue-400">üéÆ Setup Simulation</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Total Supply</label>
                    <input type="number" id="totalSupply" value="10000000"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Default: 10M tokens for realistic fan token</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Number of Users</label>
                    <input type="number" id="numUsers" value="500000"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Default: 500K users for realistic market</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Initial Liquidity (%)</label>
                    <input type="number" id="initialLiquidity" value="5" step="0.1"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">% of supply at price ‚Ç¨1</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Max Slippage (%)</label>
                    <input type="number" id="maxSlippage" value="5" step="0.1" min="0" max="100"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Buy Probability (%)</label>
                    <input type="number" id="buyProbability" value="55" step="1" min="0" max="100"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Fan tokens: 55% buy ‚Üí LOW secondary = 30% buy (more sells to refill)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">Panic Sell Probability (%)</label>
                    <input type="number" id="panicSellProbability" value="2" step="0.1" min="0" max="100"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">Chance of 100% sell during trading</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 text-gray-300">üî• Initial Dump (%)</label>
                    <input type="number" id="initialDumpProbability" value="15" step="1" min="0" max="100"
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                    <p class="text-xs text-gray-400 mt-1">% who dump at start (no limit)</p>
                </div>
            </div>

            <!-- Advanced Volume Configuration -->
            <div class="bg-gray-700 border border-gray-600 rounded p-4 mb-4">
                <h3 class="text-lg font-semibold mb-3 text-cyan-400">‚öôÔ∏è Volume Configuration (Conservative)</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Buy Tokens</label>
                        <input type="number" id="maxBuyTokens" value="100" step="10"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Max tokens per buy (~5x avg)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Sell Tokens</label>
                        <input type="number" id="maxSellTokens" value="200" step="10"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Max tokens per sell (~10x avg)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Min Sell % (Small)</label>
                        <input type="number" id="minSellPercentage" value="20" step="5" min="0" max="100"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Min % sold (small holders)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Sell % (Small)</label>
                        <input type="number" id="maxSellPercentage" value="50" step="5" min="0" max="100"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Max % sold (small holders)</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Min Sell % (Large)</label>
                        <input type="number" id="largeHolderMinSellPct" value="30" step="5" min="0" max="100"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Min % sold (large holders >1000)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Sell % (Large)</label>
                        <input type="number" id="largeHolderMaxSellPct" value="60" step="5" min="0" max="100"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Max % sold (large holders >1000)</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Configuration (Configurable, no hardcoding) -->
            <div class="bg-gray-700 border border-gray-600 rounded p-4 mb-4">
                <h3 class="text-lg font-semibold mb-3 text-orange-400">üéõÔ∏è Advanced Configuration</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Min Buy Tokens</label>
                        <input type="number" id="minBuyTokens" value="1" step="1"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Min Sell Tokens</label>
                        <input type="number" id="minSellTokens" value="1" step="1"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Large Holder Threshold</label>
                        <input type="number" id="largeHolderThreshold" value="500" step="50"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Tokens to be "large" (~25x avg)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Fee %</label>
                        <input type="number" id="feePercentage" value="1" step="0.1"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Transaction fee %</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Failures</label>
                        <input type="number" id="maxConsecutiveFailures" value="50" step="10"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Dump Logs</label>
                        <input type="number" id="maxDumpLogs" value="10" step="5"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Min Secondary Tokens</label>
                        <input type="number" id="minSecondaryTokens" value="1000" step="100"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-orange-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Min tokens to keep in secondary</p>
                    </div>
                </div>
            </div>

            <!-- Dynamic Adjustment Configuration -->
            <div class="bg-gray-700 border border-gray-600 rounded p-4 mb-4">
                <h3 class="text-lg font-semibold mb-3 text-yellow-400">üîÑ Dynamic Buy/Sell Adjustments</h3>
                <div class="mb-3">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="dynamicAdjustmentEnabled" checked
                               class="w-5 h-5 text-yellow-600 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500">
                        <span class="ml-2 text-gray-300">Enable Dynamic Adjustments</span>
                    </label>
                    <p class="text-xs text-gray-400 mt-1">Auto-adjust buy/sell based on secondary market health</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Critical Ratio</label>
                        <input type="number" id="secondaryCriticalRatio" value="0.01" step="0.01"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">< 1% = critical</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Low Ratio</label>
                        <input type="number" id="secondaryLowRatio" value="0.05" step="0.01"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">< 5% = low</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">High Ratio</label>
                        <input type="number" id="secondaryHighRatio" value="0.30" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">> 30% = high</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-3">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Buy Reduce Critical</label>
                        <input type="number" id="buyBoostCritical" value="0.25" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Buy Reduce Low</label>
                        <input type="number" id="buyBoostLow" value="0.10" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Buy Increase High</label>
                        <input type="number" id="buyReduceHigh" value="0.15" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Buy Prob</label>
                        <input type="number" id="maxBuyProbability" value="0.75" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Min Buy Prob</label>
                        <input type="number" id="minBuyProbability" value="0.25" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Buyable Ratio</label>
                        <input type="number" id="maxBuyableRatio" value="0.90" step="0.05"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                        <p class="text-xs text-gray-400 mt-1">Max % of secondary per tx</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Candlestick Interval (s)</label>
                        <input type="number" id="candlestickInterval" value="60" step="10"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Max Price History</label>
                        <input type="number" id="maxPriceHistory" value="100" step="10"
                               class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-yellow-500 focus:outline-none">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2 text-gray-300">Transaction Interval (seconds)</label>
                <input type="number" id="txInterval" value="0.5" step="0.1"
                       class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:border-blue-500 focus:outline-none">
                <p class="text-xs text-gray-400 mt-1">Time between each transaction (0.5s = 2 trades/second)</p>
            </div>

            <button onclick="setupTrading()" id="setupBtn"
                    class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                üöÄ Setup Auto-Trading
            </button>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden mt-4 p-4 bg-gray-700 rounded-lg border border-cyan-500">
                <div class="flex items-center justify-center space-x-3">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-500"></div>
                    <div>
                        <p class="text-cyan-400 font-semibold">Setting up simulation...</p>
                        <p class="text-gray-400 text-sm" id="loadingMessage">This may take a while for large configurations (10M+ users)</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Control Panel -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-purple-400">‚ö° Trading Controls</h2>

            <div class="grid grid-cols-3 gap-4">
                <button onclick="startTrading()" id="startBtn"
                        class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                    ‚ñ∂Ô∏è START Trading
                </button>
                <button onclick="stopTrading()" id="stopBtn"
                        class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                    ‚èπÔ∏è STOP Trading
                </button>
                <button onclick="resetSimulation()" id="resetBtn"
                        class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                    üîÑ RESET
                </button>
            </div>

            <div id="tradingStatus" class="mt-4 p-4 bg-gray-700 rounded-lg text-center">
                <span class="text-gray-400">Status: Ready to setup</span>
            </div>
        </div>
        
        <!-- Market Stats Row 1 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Current Price</div>
                <div id="currentPrice" class="text-3xl font-bold text-green-400">‚Ç¨0.00</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Liquidity Pool</div>
                <div id="liquidity" class="text-3xl font-bold text-blue-400">‚Ç¨0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Total Trades</div>
                <div id="totalTrades" class="text-3xl font-bold text-purple-400">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Fees Generated</div>
                <div id="feesGenerated" class="text-3xl font-bold text-orange-400">‚Ç¨0.00</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Price Change</div>
                <div id="priceChange" class="text-3xl font-bold text-yellow-400">0%</div>
            </div>
        </div>

        <!-- Market Stats Row 2 (NEW) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Volume Generated</div>
                <div id="volumeGenerated" class="text-3xl font-bold text-cyan-400">‚Ç¨0.00</div>
                <p class="text-xs text-gray-500 mt-1">Total trading volume</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Market Value</div>
                <div id="marketValue" class="text-3xl font-bold text-pink-400">‚Ç¨0.00</div>
                <p class="text-xs text-gray-500 mt-1">Tokens in circulation √ó price</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="text-gray-400 text-sm mb-1">Liquidity Ratio</div>
                <div id="liquidityRatio" class="text-3xl font-bold text-indigo-400">0.00%</div>
                <p class="text-xs text-gray-500 mt-1">Liquidity / Market Value</p>
            </div>
        </div>

        <!-- Price Chart (Candlestick) -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-green-400">üìä Price Chart (1-Minute Candles)</h2>
            <canvas id="priceChart" height="100"></canvas>
        </div>

        <!-- Market State -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-yellow-400">üìä Market State</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <div class="text-gray-400">Tokens in Circulation</div>
                    <div id="circulation" class="text-lg font-semibold text-white">0</div>
                </div>
                <div>
                    <div class="text-gray-400">Primary Market</div>
                    <div id="primaryAvailable" class="text-lg font-semibold text-blue-400">0</div>
                </div>
                <div>
                    <div class="text-gray-400">Secondary Market</div>
                    <div id="secondaryAvailable" class="text-lg font-semibold text-purple-400">0</div>
                </div>
                <div>
                    <div class="text-gray-400">Total Supply</div>
                    <div id="totalSupplyDisplay" class="text-lg font-semibold text-green-400">0</div>
                </div>
            </div>
        </div>

        <!-- Transactions Log (DexScreener style) -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-400">üí± Recent Transactions</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700">
                            <th class="text-left py-3 px-2">Type</th>
                            <th class="text-left py-3 px-2">User</th>
                            <th class="text-right py-3 px-2">Amount</th>
                            <th class="text-right py-3 px-2">Price</th>
                            <th class="text-right py-3 px-2">Total (EUR)</th>
                            <th class="text-right py-3 px-2">Market</th>
                            <th class="text-right py-3 px-2">Time</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="7" class="text-center py-8 text-gray-500">No transactions yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Traders -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
            <h2 class="text-2xl font-semibold mb-4 text-amber-400">üèÜ Top Traders</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 border-b border-gray-700">
                            <th class="text-left py-3 px-2">#</th>
                            <th class="text-left py-3 px-2">Trader</th>
                            <th class="text-right py-3 px-2">Invested</th>
                            <th class="text-right py-3 px-2">Total Value</th>
                            <th class="text-right py-3 px-2">Realized P&L</th>
                            <th class="text-right py-3 px-2">Unrealized P&L</th>
                            <th class="text-right py-3 px-2">Total P&L</th>
                            <th class="text-right py-3 px-2">P&L %</th>
                        </tr>
                    </thead>
                    <tbody id="topTradersTable" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-500">No trading activity yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let updateInterval = null;
        let priceChart = null;

        // Initialize Candlestick Chart
        const ctx = document.getElementById('priceChart').getContext('2d');
        priceChart = new Chart(ctx, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: 'Price (EUR)',
                    data: [],
                    borderColor: {
                        up: '#22c55e',    // green for bullish candles
                        down: '#ef4444',  // red for bearish candles
                        unchanged: '#6b7280'
                    },
                    backgroundColor: {
                        up: 'rgba(34, 197, 94, 0.3)',
                        down: 'rgba(239, 68, 68, 0.3)',
                        unchanged: 'rgba(107, 114, 128, 0.3)'
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#9CA3AF' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                return [
                                    `Open: ‚Ç¨${point.o.toFixed(4)}`,
                                    `High: ‚Ç¨${point.h.toFixed(4)}`,
                                    `Low: ‚Ç¨${point.l.toFixed(4)}`,
                                    `Close: ‚Ç¨${point.c.toFixed(4)}`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            color: '#9CA3AF',
                            callback: function(value) {
                                return '‚Ç¨' + value.toFixed(4);
                            }
                        },
                        grid: { color: '#374151' }
                    },
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm'
                            }
                        },
                        ticks: { color: '#9CA3AF' },
                        grid: { color: '#374151' }
                    }
                }
            }
        });

        async function setupTrading() {
            // Show loading indicator and disable button
            const loadingIndicator = document.getElementById('loadingIndicator');
            const setupBtn = document.getElementById('setupBtn');
            loadingIndicator.classList.remove('hidden');
            setupBtn.disabled = true;
            setupBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const totalSupply = document.getElementById('totalSupply').value;
            const numUsers = document.getElementById('numUsers').value;
            const initialLiquidity = document.getElementById('initialLiquidity').value;
            const maxSlippage = document.getElementById('maxSlippage').value;
            const buyProbability = document.getElementById('buyProbability').value;
            const panicSellProbability = document.getElementById('panicSellProbability').value;
            const initialDumpProbability = document.getElementById('initialDumpProbability').value;
            const maxBuyTokens = document.getElementById('maxBuyTokens').value;
            const maxSellTokens = document.getElementById('maxSellTokens').value;
            const minSellPercentage = document.getElementById('minSellPercentage').value;
            const maxSellPercentage = document.getElementById('maxSellPercentage').value;
            const largeHolderMinSellPct = document.getElementById('largeHolderMinSellPct').value;
            const largeHolderMaxSellPct = document.getElementById('largeHolderMaxSellPct').value;
            const txInterval = document.getElementById('txInterval').value;

            // Advanced configuration (ALL configurable, NO hardcoding!)
            const minBuyTokens = document.getElementById('minBuyTokens').value;
            const minSellTokens = document.getElementById('minSellTokens').value;
            const largeHolderThreshold = document.getElementById('largeHolderThreshold').value;
            const feePercentage = document.getElementById('feePercentage').value;
            const maxConsecutiveFailures = document.getElementById('maxConsecutiveFailures').value;
            const maxDumpLogs = document.getElementById('maxDumpLogs').value;
            const minSecondaryTokens = document.getElementById('minSecondaryTokens').value;

            // Dynamic adjustments
            const dynamicAdjustmentEnabled = document.getElementById('dynamicAdjustmentEnabled').checked;
            const secondaryCriticalRatio = document.getElementById('secondaryCriticalRatio').value;
            const secondaryLowRatio = document.getElementById('secondaryLowRatio').value;
            const secondaryHighRatio = document.getElementById('secondaryHighRatio').value;
            const buyBoostCritical = document.getElementById('buyBoostCritical').value;
            const buyBoostLow = document.getElementById('buyBoostLow').value;
            const buyReduceHigh = document.getElementById('buyReduceHigh').value;
            const maxBuyProbability = document.getElementById('maxBuyProbability').value;
            const minBuyProbability = document.getElementById('minBuyProbability').value;
            const maxBuyableRatio = document.getElementById('maxBuyableRatio').value;
            const candlestickInterval = document.getElementById('candlestickInterval').value;
            const maxPriceHistory = document.getElementById('maxPriceHistory').value;

            const config = {
                total_supply: parseInt(totalSupply),
                num_users: parseInt(numUsers),
                initial_liquidity_percentage: parseFloat(initialLiquidity),
                max_slippage_percentage: parseFloat(maxSlippage),
                buy_probability_percentage: parseFloat(buyProbability),
                panic_sell_probability_percentage: parseFloat(panicSellProbability),
                initial_dump_probability_percentage: parseFloat(initialDumpProbability),

                // Volume controls
                min_buy_tokens: parseInt(minBuyTokens),
                max_buy_tokens: parseInt(maxBuyTokens),
                min_sell_tokens: parseInt(minSellTokens),
                max_sell_tokens: parseInt(maxSellTokens),

                // Sell percentages
                min_sell_percentage: parseFloat(minSellPercentage),
                max_sell_percentage: parseFloat(maxSellPercentage),
                large_holder_threshold: parseInt(largeHolderThreshold),
                large_holder_min_sell_pct: parseFloat(largeHolderMinSellPct),
                large_holder_max_sell_pct: parseFloat(largeHolderMaxSellPct),

                // Advanced configuration
                max_consecutive_failures: parseInt(maxConsecutiveFailures),
                fee_percentage: parseFloat(feePercentage),
                max_dump_logs: parseInt(maxDumpLogs),

                // Dynamic adjustments
                dynamic_adjustment_enabled: dynamicAdjustmentEnabled,
                secondary_critical_ratio: parseFloat(secondaryCriticalRatio),
                secondary_low_ratio: parseFloat(secondaryLowRatio),
                secondary_high_ratio: parseFloat(secondaryHighRatio),
                buy_boost_critical: parseFloat(buyBoostCritical),
                buy_boost_low: parseFloat(buyBoostLow),
                buy_reduce_high: parseFloat(buyReduceHigh),
                max_buy_probability: parseFloat(maxBuyProbability),
                min_buy_probability: parseFloat(minBuyProbability),

                // Secondary protection
                min_secondary_tokens: parseInt(minSecondaryTokens),
                max_buyable_ratio: parseFloat(maxBuyableRatio),

                // Chart config
                candlestick_interval_seconds: parseInt(candlestickInterval),
                max_price_history: parseInt(maxPriceHistory),

                transaction_interval_seconds: parseFloat(txInterval)
            };

            // Update loading message based on size
            const loadingMsg = document.getElementById('loadingMessage');
            if (config.num_users > 1000000) {
                loadingMsg.textContent = `Setting up ${(config.num_users / 1000000).toFixed(1)}M users... This may take 30-60 seconds`;
            } else if (config.num_users > 100000) {
                loadingMsg.textContent = `Setting up ${(config.num_users / 1000).toFixed(0)}K users... Please wait`;
            } else {
                loadingMsg.textContent = 'Initializing simulation...';
            }

            console.log('üöÄ Setup config:', config);
            console.log(`   Total Supply: ${config.total_supply.toLocaleString()} tokens`);
            console.log(`   Initial Liquidity: ${config.initial_liquidity_percentage}%`);
            console.log(`   Expected tokens: ${(config.total_supply * config.initial_liquidity_percentage / 100).toLocaleString()}`);
            console.log(`   Expected liquidity (at ‚Ç¨1/token): ‚Ç¨${(config.total_supply * config.initial_liquidity_percentage / 100).toLocaleString()}`);

            try {
                const response = await fetch(`${API_BASE}/api/trading/setup`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                console.log('‚úÖ Setup response:', data);

                if (data.success) {
                    const expectedLiquidity = config.total_supply * (config.initial_liquidity_percentage / 100);
                    console.log(`üìä Expected liquidity: ‚Ç¨${expectedLiquidity.toLocaleString()}`);
                    console.log(`üìä Actual liquidity: ‚Ç¨${data.initial_state.current_liquidity.toLocaleString()}`);

                    // Verify liquidity matches expectation
                    if (Math.abs(data.initial_state.current_liquidity - expectedLiquidity) > 1) {
                        console.error('‚ö†Ô∏è MISMATCH! Expected liquidity does not match actual!');
                        console.error(`   Expected: ‚Ç¨${expectedLiquidity.toLocaleString()}`);
                        console.error(`   Actual: ‚Ç¨${data.initial_state.current_liquidity.toLocaleString()}`);
                    }

                    // Verify liquidity distribution
                    if (data.distribution) {
                        console.log(`üéÅ Liquidity Distribution:`);
                        console.log(`   Tokens distributed: ${data.distribution.tokens_distributed.toLocaleString()}`);
                        console.log(`   Users received: ${data.distribution.users_received}`);
                    } else {
                        console.warn('‚ö†Ô∏è No distribution data returned!');
                    }

                    // Show initial dumps info
                    if (data.initial_dumps && data.initial_dumps.success) {
                        console.log(`\nüí• Initial Dumps Executed:`);
                        console.log(`   Users dumped: ${data.initial_dumps.dumps_executed}/${data.initial_dumps.total_users} (${data.initial_dumps.dump_percentage.toFixed(1)}%)`);
                        console.log(`   Tokens dumped: ${data.initial_dumps.total_tokens_dumped.toLocaleString()}`);
                        console.log(`   EUR from dumps: ‚Ç¨${data.initial_dumps.total_eur_from_dumps.toLocaleString()}`);
                        console.log(`   Secondary market: ${data.initial_dumps.secondary_market_after.toLocaleString()} tokens`);
                    }

                    const sellProbability = 100 - config.buy_probability_percentage;
                    document.getElementById('tradingStatus').innerHTML =
                        `<span class="text-green-400">‚úÖ Setup Complete!<br>
                         Supply: ${config.total_supply.toLocaleString()} |
                         Liquidity: ‚Ç¨${data.initial_state.current_liquidity.toLocaleString()} |
                         Buy: ${config.buy_probability_percentage}% / Sell: ${sellProbability}%</span>`;
                    updateStats();
                    
                    // Reset chart
                    priceChart.data.labels = [];
                    priceChart.data.datasets[0].data = [];
                    priceChart.update();
                } else {
                    document.getElementById('tradingStatus').innerHTML =
                        `<span class="text-red-400">‚ùå Setup Failed: ${data.message}</span>`;
                }
            } catch (error) {
                console.error('Setup error:', error);
                document.getElementById('tradingStatus').innerHTML =
                    `<span class="text-red-400">‚ùå Error: ${error.message}</span>`;
            } finally {
                // Hide loading indicator and re-enable button
                loadingIndicator.classList.add('hidden');
                setupBtn.disabled = false;
                setupBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        async function startTrading() {
            try {
                const response = await fetch(`${API_BASE}/api/trading/start`, {method: 'POST'});
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('tradingStatus').innerHTML = 
                        `<span class="text-green-400 animate-pulse">üî• Trading ACTIVE - Auto-updating...</span>`;
                    
                    // Start auto-update
                    if (updateInterval) clearInterval(updateInterval);
                    updateInterval = setInterval(updateStats, 2000); // Update every 2 seconds
                } else {
                    document.getElementById('tradingStatus').innerHTML = 
                        `<span class="text-red-400">‚ùå ${data.message}</span>`;
                }
            } catch (error) {
                console.error('Start error:', error);
            }
        }

        async function stopTrading() {
            try {
                const response = await fetch(`${API_BASE}/api/trading/stop`, {method: 'POST'});
                const data = await response.json();

                if (data.success) {
                    document.getElementById('tradingStatus').innerHTML =
                        `<span class="text-yellow-400">‚èπÔ∏è Trading STOPPED - ${data.stats.total_trades} trades executed</span>`;

                    // Stop auto-update
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }

                    updateStats();
                } else {
                    document.getElementById('tradingStatus').innerHTML =
                        `<span class="text-red-400">‚ùå ${data.message}</span>`;
                }
            } catch (error) {
                console.error('Stop error:', error);
            }
        }

        async function resetSimulation() {
            try {
                console.log('üîÑ Resetting simulation...');

                // Stop trading if active
                await fetch(`${API_BASE}/api/trading/stop`, {method: 'POST'});

                // Clear update interval
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }

                // Reset chart
                priceChart.data.labels = [];
                priceChart.data.datasets[0].data = [];
                priceChart.update();

                // Reset market stats
                document.getElementById('currentPrice').textContent = '‚Ç¨0.00';
                document.getElementById('liquidity').textContent = '‚Ç¨0';
                document.getElementById('totalTrades').textContent = '0';
                document.getElementById('feesGenerated').textContent = '‚Ç¨0.00';
                document.getElementById('priceChange').textContent = '0.00%';
                document.getElementById('priceChange').className = 'text-3xl font-bold text-gray-400';

                // Reset new metrics (Row 2)
                document.getElementById('volumeGenerated').textContent = '‚Ç¨0.00';
                document.getElementById('marketValue').textContent = '‚Ç¨0.00';
                document.getElementById('liquidityRatio').textContent = '0.00%';

                // Reset market state
                document.getElementById('circulation').textContent = '0';
                document.getElementById('primaryAvailable').textContent = '0';
                document.getElementById('secondaryAvailable').textContent = '0';
                document.getElementById('totalSupplyDisplay').textContent = '0';

                // Clear transactions table
                document.getElementById('transactionsTable').innerHTML =
                    '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">No transactions yet</td></tr>';

                // Clear top traders table
                document.getElementById('topTradersTable').innerHTML =
                    '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-400">No traders yet</td></tr>';

                // Reset status message
                document.getElementById('tradingStatus').innerHTML =
                    '<span class="text-gray-400">Status: Ready to setup</span>';

                console.log('‚úÖ Simulation reset complete!');

            } catch (error) {
                console.error('Reset error:', error);
                document.getElementById('tradingStatus').innerHTML =
                    `<span class="text-red-400">‚ùå Reset Error: ${error.message}</span>`;
            }
        }

        async function updateStats() {
            try {
                const statusResponse = await fetch(`${API_BASE}/api/trading/status`);
                const statusData = await statusResponse.json();
                
                if (!statusData.success) return;
                
                const state = statusData.current_state;
                const stats = statusData.stats;
                
                // Update stats
                document.getElementById('currentPrice').textContent =
                    `‚Ç¨${state.current_price.toFixed(4)}`;
                document.getElementById('liquidity').textContent =
                    `‚Ç¨${state.current_liquidity.toFixed(0)}`;
                document.getElementById('totalTrades').textContent =
                    statusData.trade_count;

                // Update fees generated
                if (stats.total_fees_generated !== undefined) {
                    document.getElementById('feesGenerated').textContent =
                        `‚Ç¨${stats.total_fees_generated.toFixed(2)}`;
                }

                // Update volume generated (NEW)
                if (stats.total_volume_eur !== undefined) {
                    document.getElementById('volumeGenerated').textContent =
                        `‚Ç¨${stats.total_volume_eur.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }

                // Update market value (NEW)
                if (stats.market_value !== undefined) {
                    document.getElementById('marketValue').textContent =
                        `‚Ç¨${stats.market_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }

                // Update liquidity ratio (NEW)
                if (stats.liquidity_ratio_percent !== undefined) {
                    document.getElementById('liquidityRatio').textContent =
                        `${stats.liquidity_ratio_percent.toFixed(2)}%`;
                }

                if (stats.price_change_percent !== undefined) {
                    const change = stats.price_change_percent;
                    const changeColor = change >= 0 ? 'text-green-400' : 'text-red-400';
                    document.getElementById('priceChange').className = `text-3xl font-bold ${changeColor}`;
                    document.getElementById('priceChange').textContent =
                        `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                }

                // Update market state
                document.getElementById('circulation').textContent =
                    state.tokens_in_circulation.toFixed(0);
                document.getElementById('primaryAvailable').textContent =
                    state.tokens_available_primary.toFixed(0);
                document.getElementById('secondaryAvailable').textContent =
                    state.tokens_available_secondary.toFixed(0);
                document.getElementById('totalSupplyDisplay').textContent =
                    state.total_supply;

                // Update candlestick chart
                if (stats.candlestick_data && stats.candlestick_data.length > 0) {
                    const candlestickData = stats.candlestick_data.map(candle => ({
                        x: candle.time * 1000, // Convert to milliseconds for Chart.js
                        o: candle.open,
                        h: candle.high,
                        l: candle.low,
                        c: candle.close
                    }));

                    priceChart.data.datasets[0].data = candlestickData;
                    priceChart.update('none'); // No animation for live updates
                }

                // Update transactions table
                await updateTransactions();

                // Update top traders table
                await updateTopTraders();

            } catch (error) {
                console.error('Update error:', error);
            }
        }

        async function updateTransactions() {
            try {
                const response = await fetch(`${API_BASE}/api/transactions?limit=20`);
                const data = await response.json();

                if (!data.success || !data.data || data.data.length === 0) {
                    return;
                }

                const tbody = document.getElementById('transactionsTable');

                // Get last 20 transactions in reverse order (newest first)
                const transactions = data.data.slice().reverse();

                tbody.innerHTML = transactions.map(tx => {
                    // Determine transaction type and styling
                    let type, typeColor, market, amount, price, total;

                    if (tx.action === 'purchase_primary') {
                        type = 'üìà BUY';
                        typeColor = 'text-green-400';
                        market = 'Primary';
                        amount = tx.tokens_bought.toFixed(2);
                        price = tx.price.toFixed(4);
                        total = tx.amount_eur.toFixed(2);
                    } else if (tx.action === 'buy_from_secondary') {
                        type = 'üìà BUY';
                        typeColor = 'text-green-400';
                        market = 'Secondary';
                        amount = tx.tokens_bought.toFixed(2);
                        price = tx.exec_price.toFixed(4);
                        total = tx.amount_eur.toFixed(2);
                    } else if (tx.action === 'sell_simple') {
                        type = 'üìâ SELL';
                        typeColor = 'text-red-400';
                        market = 'Pool';
                        amount = tx.tokens_sold.toFixed(2);
                        price = tx.exec_price.toFixed(4);
                        total = tx.payout_eur.toFixed(2);
                    } else if (tx.action === 'liquidity') {
                        type = 'üíß LP';
                        typeColor = 'text-blue-400';
                        market = 'Initial';
                        amount = tx.tokens_bought.toFixed(2);
                        price = tx.price.toFixed(4);
                        total = tx.amount_eur.toFixed(2);
                    } else if (tx.action === 'liquidity_distribution') {
                        type = 'üéÅ DIST';
                        typeColor = 'text-purple-400';
                        market = 'Airdrop';
                        amount = tx.total_distributed || 0;
                        price = '-';
                        total = '-';
                    } else {
                        type = tx.action;
                        typeColor = 'text-gray-400';
                        market = '-';
                        amount = '-';
                        price = '-';
                        total = '-';
                    }

                    const userName = tx.user_name || `User_${tx.user_id}`;
                    const timeAgo = 'Just now';

                    return `
                        <tr class="hover:bg-gray-700 transition-colors">
                            <td class="py-2 px-2 ${typeColor} font-semibold">${type}</td>
                            <td class="py-2 px-2 text-gray-300">${userName}</td>
                            <td class="py-2 px-2 text-right text-white">${amount}</td>
                            <td class="py-2 px-2 text-right text-gray-300">‚Ç¨${price}</td>
                            <td class="py-2 px-2 text-right text-white">‚Ç¨${total}</td>
                            <td class="py-2 px-2 text-right text-cyan-400">${market}</td>
                            <td class="py-2 px-2 text-right text-gray-400 text-xs">${timeAgo}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Transactions update error:', error);
            }
        }

        async function updateTopTraders() {
            try {
                const response = await fetch(`${API_BASE}/api/trading/top-traders?limit=10`);
                const data = await response.json();

                if (!data.success || !data.data || data.data.length === 0) {
                    return;
                }

                const tbody = document.getElementById('topTradersTable');
                const traders = data.data;

                tbody.innerHTML = traders.map((trader, index) => {
                    const pnlColor = trader.total_pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    const pnlSign = trader.total_pnl >= 0 ? '+' : '';

                    const rankColor = index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : index === 2 ? 'text-amber-600' : 'text-gray-500';
                    const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;

                    return `
                        <tr class="hover:bg-gray-700 transition-colors">
                            <td class="py-2 px-2 ${rankColor} font-semibold">${rankIcon}</td>
                            <td class="py-2 px-2 text-gray-300">${trader.user_name}</td>
                            <td class="py-2 px-2 text-right text-blue-300">‚Ç¨${trader.total_invested.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right text-white font-semibold">‚Ç¨${trader.total_value.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right text-purple-300">‚Ç¨${trader.realized_pnl.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right text-cyan-300">‚Ç¨${trader.unrealized_pnl.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right ${pnlColor} font-semibold">${pnlSign}‚Ç¨${trader.total_pnl.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right ${pnlColor} font-bold">${pnlSign}${trader.pnl_percentage.toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Top traders update error:', error);
            }
        }

        // Initial stats load
        updateStats();
    </script>
</body>
</html>

